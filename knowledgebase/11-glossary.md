# Glossary

## Domain Terms

**Booking** — A vehicle rental reservation. Contains all pricing, dates, customer, and vehicle information. Lifecycle: `draft` → `pending` → `confirmed` → `active` → `completed` (or `cancelled`).

**Booking Code** — Human-readable identifier (e.g., "BR-001234") generated by a database trigger on booking creation. Used in customer-facing communications.

**Hold / Reservation Hold** — A temporary lock on vehicle availability during checkout (15-minute TTL). Stored in `reservation_holds`. Prevents double-booking during the payment flow.

**Add-On** — Optional rental extras (child seat, GPS, fuel service, etc.). Priced per-day with optional one-time fees. Stored in `add_ons` table; booking-specific instances in `booking_add_ons`.

**Additional Driver** — A secondary driver added to the rental. Priced per-day based on age band. Stored in `booking_additional_drivers`.

**Protection Plan** — Insurance/coverage tier selected by the customer. Options: `none`, `basic` ($32.99/day), `smart` ($37.99/day), `premium`/All Inclusive ($49.99/day). Premium includes roadside assistance.

**Driver Age Band** — Age classification for pricing: `20_24` (young driver, $15/day surcharge) or `25_70` (standard, no surcharge). Minimum age 20, maximum age 70.

**Young Driver Fee** — $15/day surcharge for drivers aged 20-24.

## Fee Terms

**Daily Rate** — Base vehicle rental rate per day. From `vehicles.daily_rate`.

**Weekend Surcharge** — 15% surcharge on the vehicle base total for Friday/Saturday/Sunday pickups.

**Duration Discount** — 10% for 7+ days (weekly), 20% for 21+ days (monthly). Applied after weekend surcharge.

**PVRT (Passenger Vehicle Rental Tax)** — BC regulatory fee of $1.50/day.

**ACSRCH (Airport Concession Surcharge)** — Regulatory fee of $1.00/day.

**Delivery Fee** — Charge for vehicle delivery to customer's location.

**Drop-off Fee / Different Drop-off Fee** — Fee for returning vehicle to a different location than pickup. Determined by `fee_group` pairs on the `locations` table. $50 (Surrey↔Langley), $75 (Abbotsford↔Surrey/Langley).

**Fee Group** — Classification on the `locations` table that determines inter-location drop-off fee tiers. Values: `surrey`, `langley`, `abbotsford`.

**Upgrade Daily Fee** — Per-day surcharge when staff upgrades a customer's vehicle to a higher category.

**Deposit** — Security deposit of $350 (fixed). Held via Stripe PaymentIntent. Can be captured (fully or partially) or released.

**Late Return Fee** — Per-hour charge for returning the vehicle after the scheduled end time. $25/hour after 30-minute grace period.

## Technical Terms

**Seatbelt Trigger** — A PostgreSQL BEFORE trigger that `RAISE EXCEPTION` to prevent unauthorized writes. Named for acting as a safety belt that prevents accidental financial data corruption. Three seatbelts exist: `trg_block_sensitive_booking_updates`, `trg_enforce_addon_price`, `trg_enforce_driver_fee`.

**FORCE RLS** — PostgreSQL `ALTER TABLE ... FORCE ROW LEVEL SECURITY`. Makes RLS policies apply even to table owners, not just non-owner roles. Only `service_role` bypasses.

**Service Role** — The `SUPABASE_SERVICE_ROLE_KEY` which bypasses RLS and seatbelt triggers. Used exclusively in edge functions for privileged operations.

**Fail-Closed** — Security design pattern where the system defaults to denying access/operation when an error occurs. Used in pricing validation: if `computeBookingTotals()` throws, the booking is rejected rather than falling back to client values.

**Price Mismatch Tolerance** — $0.50 threshold for acceptable difference between client-computed and server-computed booking totals. Exists to absorb floating-point rounding differences, not to allow intentional price drift.

**Monotonic Status Guard** — Logic in `stripe-webhook` that prevents booking status from being downgraded. e.g., if a booking is already `confirmed`, a webhook trying to set it to `pending` is ignored.

**Access Token** — A 30-minute TTL bearer token minted via OTP verification for guest users. Stored as a SHA-256 hash in `booking_access_tokens`. Used for payment flows where the guest has no Supabase JWT.

**OTP (One-Time Password)** — 6-digit code sent via SMS/email to guest users for identity verification. Stored as SHA-256 hash in `booking_otps` with 10-minute expiry and 5-attempt lockout.

**Idempotency Key** — A unique identifier used to prevent duplicate processing. Used in notification dispatch (`notification_logs.idempotency_key`) and webhook handling (`stripe_webhook_events.event_id`).

**Shadow User** — An auth.users record created for guest bookings with a random password and `is_guest: true` metadata. Allows the booking to reference a `user_id` even for unauthenticated customers.

## Ops Terms

**Counter Upsell** — Adding or removing add-ons at the rental counter (in-person). Performed by staff via `persist-booking-extras` edge function.

**Repricing** — Server-side recalculation of booking financial fields. Triggered by duration changes, upsells, or vehicle upgrades via `reprice-booking` edge function.

**Handover** — The process of giving the vehicle to the customer. Includes condition documentation, ID verification, payment confirmation.

**Activation** — Transitioning a booking from `confirmed` to `active` — the rental has officially started.

**Account Closure** — Final settlement of a completed rental: generating the final invoice, processing any remaining charges/refunds, and closing the booking.

**Void** — Admin-only cancellation of a booking. Sets status to `cancelled` with audit trail. Cannot void `completed` or already `cancelled` bookings.

## Database Tables (Key)

| Table | Purpose |
|-------|---------|
| `bookings` | Core booking record with all pricing, dates, status |
| `booking_add_ons` | Join table: bookings ↔ add_ons with server-computed price |
| `booking_additional_drivers` | Additional drivers with server-computed fees |
| `payments` | Payment ledger (rentals, deposits, refunds) |
| `deposit_ledger` | Deposit lifecycle tracking (hold, capture, release) |
| `vehicles` | Vehicle categories with daily rates |
| `vehicle_units` | Physical vehicle instances (VINs) |
| `locations` | Rental locations with `fee_group` |
| `add_ons` | Available add-on catalog with rates |
| `system_settings` | Configurable rates (protection, driver fees) |
| `profiles` | User profile data (name, email, phone, license) |
| `user_roles` | Role assignments (admin, staff, cleaner, finance) |
| `audit_logs` | Immutable audit trail for all sensitive operations |
| `stripe_webhook_events` | Webhook idempotency tracking |
| `notification_logs` | Notification deduplication |
| `reservation_holds` | Temporary availability locks |
| `booking_otps` | Guest OTP records |
| `booking_access_tokens` | Guest access tokens |
| `rate_limits` | Atomic rate limit counters |
